# Telegram News Bot

Телеграм-бот, созданный с использованием Python и библиотеки aiogram, который собирает новости из различных источников, позволяет пользователям устанавливать источники новостей по умолчанию и предоставляет обновления новостей по подписке с настраиваемыми интервалами.

## Возможности

- Получение новостей по запросу с помощью команды /news <источник> (например, /news bbc).
- Установка источника новостей по умолчанию с помощью /setsource <источник>.
- Подписка на периодические обновления новостей с помощью /subscribe и выбор интервалов (например, каждую минуту, каждый час или каждый день).
- Отписка от источников новостей с помощью /unsubscribe <источник>.
- Просмотр списка доступных источников новостей с помощью /listsources.
- Просмотр активных подписок с помощью /listsubscriptions.
- Постоянное хранение предпочтений пользователей и подписок в базе данных.
- Поддержка Docker Compose для удобного развертывания.

## Требования

- Python 3.8 или выше
- Токен бота Telegram (получите у [BotFather](https://t.me/BotFather))
- Docker (опционально, если используется Docker Compose)
- Ключи NEWSAPI (получите на [NEWSAPI](https://newsapi.org/))

## Установка

1. Клонируйте репозиторий

```bash
git clone https://github.com/yourusername/telegram-news-bot.git cd telegram-news-bot
```

- Настройте бота

- В файле `config.py` настройте источники новостей:

```python
NEWS_SOURCES = {    "bloomberg": "bloomberg",    "kommersant": "kommersant",    "reuters": "reuters",    "bbc": "bbc-news"  # Соответствует идентификаторам источников NewsAPI }
```

**Бот использует базу данных PostgreSQL (через SQLAlchemy) для хранения данных о пользователях и подписках. По умолчанию инициализация происходит при запуске:**

- Убедитесь, что файл `modules/db.py` настроен с указанием URL базы данных (например, SQLite или PostgreSQL).

- Создайте файл `.env` в корневой директории проекта, если его нет:

  ```text
  TELEGRAM_TOKEN=ваш-токен-бота-telegram
  NEWSAPI_KEY=КЛЮЧ_NEWSAPI
  ```

- Отредактируйте `docker-compose.yml` , добавив **TELEGRAM_TOKEN, NEWSAPI_KEY, DB_USER, DB_PASSWORD**:

```dockerfile
    environment:
    - TELEGRAM_TOKEN=ваш-токен-бота-telegram   
    - NEWSAPI_KEY=КЛЮЧ_NEWSAPI
    - DB_USER=
    ........
```

1. Соберите и запустите:

```bash
docker-compose up --build -d
```

## Использование

1. Запустите бота, отправив команду /start в Telegram.
2. Используйте команды из сообщения помощи:
   - /news bbc — Получить последние новости от BBC.
   - /setsource bloomberg — Установить Bloomberg как источник по умолчанию.
   - /subscribe — Начать процесс настройки подписки (выберите источник и интервал через встроенные кнопки).
   - /unsubscribe bbc — Остановить обновления новостей от BBC.
   - /listsources — Посмотреть все доступные источники новостей.
   - /listsubscriptions — Просмотреть ваши активные подписки.

## Скриншоты

Скриншоты можно найти в разделе [screenshots]()

# Схема базы данных

Telegram News Bot использует базу данных PostgreSQL, управляемую через SQLAlchemy, для хранения информации о пользователях и предпочтений по подпискам. Ниже приведена схема моделей базы данных, определённых в modules/db.py.

## Обзор

База данных состоит из двух таблиц:

- **users** — Хранит информацию о пользователях Telegram.
- **subscriptions** — Отслеживает подписки пользователей на источники новостей с интервалами доставки.

Схема легковесная, разработана для автоматической регистрации пользователей и гибкого управления подписками без хранения самих новостей.

## Подробности схемы

### Таблица: users

**Назначение**: Хранит уникальных пользователей Telegram на основе их идентификатора чата.

| Колонка          | Тип         | Ограничения         | Описание                                  |
| ---------------- | ----------- | ------------------- | ----------------------------------------- |
| id               | Целое число | Первичный ключ      | Уникальный идентификатор пользователя.    |
| telegram_chat_id | Строка      | Уникальное, Не null | Идентификатор чата Telegram пользователя. |

- **Первичный ключ**: id (автоинкремент).
- **Уникальное ограничение**: telegram_chat_id предотвращает дублирование пользователей.

### Таблица: subscriptions

**Назначение**: Управляет подписками пользователей на источники новостей, включая предпочитаемые интервалы доставки. Также используется для хранения источника по умолчанию (с interval_hours = 0).

| Колонка        | Тип         | Ограничения                      | Описание                                                     |
| -------------- | ----------- | -------------------------------- | ------------------------------------------------------------ |
| id             | Целое число | Первичный ключ                   | Уникальный идентификатор подписки.                           |
| user_id        | Целое число | Внешний ключ (users.id), Не null | Ссылка на пользователя, владеющего подпиской.                |
| source         | Строка      | Не null                          | Источник новостей (например, "bbc", "reuters").              |
| interval_hours | Целое число | Не null                          | Интервал доставки в минутах (несмотря на название, переиспользуется из часов). 0 обозначает источник по умолчанию. |

- **Первичный ключ**: id (автоинкремент).
- **Внешний ключ**: user_id связан с users(id) с каскадной зависимостью.
- Примечания:
  - interval_hours исторически назван так, но в текущей реализации представляет минуты (например, 15 для 15 минут, 1440 для 1 дня).
  - Подписка с interval_hours = 0 обозначает источник новостей по умолчанию, а не активную периодическую подписку.

- ## Связи

  - Один ко многим: Один User может иметь несколько записей 

    Subscription

     (например, подписки на разные источники или источник по умолчанию).

    - users.id → subscriptions.user_id.

  ## Расширение бота

  - Добавляйте новые источники новостей в config.py и обновляйте news_fetcher.py для их обработки.
  - Измените modules/db.py, чтобы использовать другую базу данных (например, PostgreSQL), обновив SQLALCHEMY_DATABASE_URL.
